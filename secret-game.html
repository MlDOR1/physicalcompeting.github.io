<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beat Portal - Physical Competing</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700;900&family=Montserrat:wght@400;500;600;700;900&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: radial-gradient(circle at top, #080b1a, #010105 60%);
            font-family: 'Montserrat', 'Kanit', sans-serif;
            color: #ffffff;
            overflow: hidden;
        }

        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .lane {
            position: absolute;
            bottom: 100px;
            width: 100px;
            height: calc(100vh - 200px);
            border: 2px solid rgba(255, 255, 255, 0.12);
            background: rgba(255, 255, 255, 0.02);
        }

        .lane-0 { left: calc(50% - 210px); border-color: rgba(255, 102, 222, 0.35); }
        .lane-1 { left: calc(50% - 105px); border-color: rgba(90, 215, 255, 0.35); }
        .lane-2 { left: calc(50% + 0px); border-color: rgba(120, 255, 142, 0.35); }
        .lane-3 { left: calc(50% + 105px); border-color: rgba(255, 231, 92, 0.35); }

        .target-zone {
            position: absolute;
            bottom: 20px;
            width: 100px;
            height: 100px;
            border: 3px solid;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            background: rgba(0, 0, 0, 0.55);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.12);
            transition: transform 0.12s ease, background 0.12s ease;
        }

        .target-0 {
            left: calc(50% - 210px);
            border-color: #ff66de;
            color: #ff66de;
        }

        .target-1 {
            left: calc(50% - 105px);
            border-color: #5ad7ff;
            color: #5ad7ff;
        }

        .target-2 {
            left: calc(50% + 0px);
            border-color: #78ff8e;
            color: #78ff8e;
        }

        .target-3 {
            left: calc(50% + 105px);
            border-color: #ffe75c;
            color: #ffe75c;
        }

        .arrow {
            position: absolute;
            width: 80px;
            height: 80px;
            font-size: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 0 0 18px currentColor;
            animation: fall linear;
        }

        .arrow-0 { color: #ff66de; left: calc(50% - 200px); }
        .arrow-1 { color: #5ad7ff; left: calc(50% - 95px); }
        .arrow-2 { color: #78ff8e; left: calc(50% + 10px); }
        .arrow-3 { color: #ffe75c; left: calc(50% + 115px); }

        @keyframes fall {
            from { transform: translateY(-120px); }
            to { transform: translateY(calc(100vh - 120px)); }
        }

        #ui {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            pointer-events: none;
        }

        #backBtn {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 0.6rem 1.3rem;
            border-radius: 999px;
            border: none;
            font-size: 0.95rem;
            font-weight: 600;
            letter-spacing: 0.04em;
            color: #03040a;
            background: linear-gradient(135deg, #5ad7ff, #ff66de);
            box-shadow: 0 12px 30px rgba(114, 201, 255, 0.4);
            cursor: pointer;
            pointer-events: all;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        #backBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 18px 40px rgba(114, 201, 255, 0.55);
        }

        #scoreBoard {
            margin: 20px auto 0;
            max-width: 420px;
            display: flex;
            justify-content: space-between;
            gap: 1.5rem;
            padding: 0.7rem 1.5rem;
            background: rgba(0, 0, 0, 0.65);
            border-radius: 999px;
            border: 1px solid rgba(110, 136, 224, 0.4);
            backdrop-filter: blur(6px);
            pointer-events: none;
        }

        #scoreBoard div {
            font-size: 1rem;
            letter-spacing: 0.04em;
        }

        #progressBar {
            position: fixed;
            bottom: 0;
            left: 0;
            height: 5px;
            background: linear-gradient(90deg, #ff66de, #5ad7ff, #78ff8e, #ffe75c);
            width: 0%;
            transition: width 0.1s linear;
            box-shadow: 0 0 12px rgba(106, 176, 255, 0.45);
        }

        #startScreen,
        #endScreen {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            background: rgba(4, 6, 18, 0.94);
            backdrop-filter: blur(12px);
            transition: opacity 0.3s ease;
            z-index: 1100;
        }

        .hidden {
            opacity: 0;
            pointer-events: none;
        }

        #startScreen h1,
        #endScreen h1 {
            font-size: 2.6rem;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }

        #startScreen h2 {
            font-size: 1.8rem;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            margin-bottom: 2rem;
            color: rgba(199, 221, 255, 0.9);
        }

        #startScreen .instruction {
            max-width: 520px;
            font-size: 1rem;
            line-height: 1.6;
            color: rgba(225, 233, 255, 0.9);
            margin-bottom: 1.2rem;
        }

        #startScreen .key-row {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .key-hint {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1.3rem;
            border-radius: 999px;
            font-weight: 600;
            letter-spacing: 0.08em;
            border: 1px solid currentColor;
            box-shadow: 0 10px 25px rgba(90, 215, 255, 0.22);
        }

        .key-hint.lane-0 { color: #ff66de; }
        .key-hint.lane-1 { color: #5ad7ff; }
        .key-hint.lane-2 { color: #78ff8e; }
        .key-hint.lane-3 { color: #ffe75c; }

        #startScreen .timing {
            font-size: 0.9rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: rgba(188, 204, 255, 0.75);
        }

        #startScreen button,
        #endScreen button {
            margin-top: 2.2rem;
            padding: 0.85rem 2.8rem;
            border-radius: 999px;
            border: none;
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            color: #041020;
            background: linear-gradient(135deg, #ff66de, #5ad7ff);
            box-shadow: 0 18px 40px rgba(126, 203, 255, 0.45);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        #startScreen button:hover,
        #endScreen button:hover {
            transform: translateY(-3px);
            box-shadow: 0 24px 55px rgba(126, 203, 255, 0.6);
        }

        #endScreen button.secondary {
            margin-left: 1.2rem;
            background: rgba(255, 255, 255, 0.14);
            color: #f1f5ff;
            box-shadow: none;
            border: 1px solid rgba(159, 182, 255, 0.6);
        }

        #endScreen button.secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 18px 40px rgba(126, 203, 255, 0.4);
        }

        .judgment {
            position: fixed;
            top: 42%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 3.5rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            animation: pop 0.35s ease;
            pointer-events: none;
        }

        .judgment.perfect { color: #78ff8e; text-shadow: 0 0 18px rgba(120, 255, 142, 0.55); }
        .judgment.good { color: #5ad7ff; text-shadow: 0 0 18px rgba(90, 215, 255, 0.55); }
        .judgment.miss { color: #ff5577; text-shadow: 0 0 18px rgba(255, 85, 119, 0.55); }

        @keyframes pop {
            from { opacity: 0; transform: translate(-50%, -20px) scale(0.9); }
            to { opacity: 1; transform: translate(-50%, 0) scale(1); }
        }

        #finalScore {
            font-size: 2.2rem;
            margin: 1.2rem 0;
        }

        #finalStats {
            font-size: 1.1rem;
            color: rgba(222, 232, 255, 0.85);
            line-height: 1.6;
        }

        #rank {
            font-size: 3.5rem;
            letter-spacing: 0.15em;
            margin: 1.5rem 0;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div class="lane lane-0"></div>
        <div class="lane lane-1"></div>
        <div class="lane lane-2"></div>
        <div class="lane lane-3"></div>

        <div class="target-zone target-0">&larr;</div>
        <div class="target-zone target-1">&darr;</div>
        <div class="target-zone target-2">&uarr;</div>
        <div class="target-zone target-3">&rarr;</div>
    </div>

    <div id="ui">
        <button id="backBtn" onclick="goBack()">Return to Main Site</button>
        <div id="scoreBoard">
            <div id="score">Score: 0</div>
            <div id="combo">Combo: 0</div>
            <div id="accuracy">Perfect: 0 | Good: 0 | Miss: 0</div>
        </div>
        <div id="progressBar"></div>
    </div>

    <div id="startScreen">
        <h1>Physical Competing</h1>
        <h2>Rhythm Portal</h2>
        <div class="instruction">
            Hidden in the archives lies a four-lane tribute to dance cabinets. Catch the notes as they pass through the glowing gates while Night of Nights remix hammers in the background—laughs (and cramps) guaranteed.
        </div>
        <div class="instruction key-row">
            <span class="key-hint lane-0">A / &larr;</span>
            <span class="key-hint lane-1">S / &darr;</span>
            <span class="key-hint lane-2">W / &uarr;</span>
            <span class="key-hint lane-3">D / &rarr;</span>
        </div>
        <div class="instruction timing">
            Perfect window: ±50ms &nbsp;|&nbsp; Good window: ±100ms &nbsp;|&nbsp; Miss: outside the groove
        </div>
        <button onclick="startGame()">Start the Beat</button>
    </div>

    <div id="endScreen" class="hidden">
        <h1>Set Complete!</h1>
        <div id="finalScore"></div>
        <div id="finalStats"></div>
        <div id="rank"></div>
        <button onclick="restartGame()">Retry Chart</button>
        <button class="secondary" onclick="goBack()">Return to Main Site</button>
    </div>

    <script>
        const audio = new Audio('night-of-nights-flowering-nights-remix--by-coolcreatebeatmario.mp3');
        audio.preload = 'auto';
        audio.volume = 0.7;

        const DEFAULT_DURATION = 120000;
        let songDurationMs = DEFAULT_DURATION;
        audio.addEventListener('loadedmetadata', () => {
            if (!isNaN(audio.duration)) {
                songDurationMs = audio.duration * 1000;
            }
        });

        audio.addEventListener('ended', () => {
            if (gameActive) {
                endGame();
            }
        });

        const ARROW_TRAVEL_TIME = 1600;
        const BPM = 220;
        const QUARTER = (60 / BPM) * 1000;
        const EIGHTH = QUARTER / 2;
        const SIXTEENTH = QUARTER / 4;

        // Game variables
        let score = 0;
        let combo = 0;
        let maxCombo = 0;
        let perfect = 0;
        let good = 0;
        let miss = 0;
        let arrows = [];
        let gameActive = false;
        let gameStartTime = 0;
        let scheduledTimeouts = [];

        function scheduleTimeout(callback, delay) {
            const handle = setTimeout(() => {
                scheduledTimeouts = scheduledTimeouts.filter(h => h !== handle);
                callback();
            }, delay);
            scheduledTimeouts.push(handle);
        }

        function clearScheduledTimeouts() {
            scheduledTimeouts.forEach(clearTimeout);
            scheduledTimeouts = [];
        }

        function generateBeatmap() {
            const combos = [
                [0], [2], [1], [3],
                [0, 2], [1, 3],
                [0, 1, 2], [1, 2, 3],
                [0, 3], [0, 1, 3],
                [0, 2, 3], [2, 3],
                [0, 1], [1, 2],
                [2, 3], [0, 3]
            ];

            const result = [];
            let time = 2500; // give the player a moment before chaos

            for (let measure = 0; measure < 56; measure++) {
                for (let step = 0; step < 8; step++) {
                    const pattern = combos[(measure * 8 + step) % combos.length];
                    const currentTime = Math.round(time);
                    pattern.forEach(lane => result.push([lane, currentTime]));

                    if (step === 2 || step === 6) {
                        const burstLane = (pattern[0] + measure + step) % 4;
                        result.push([burstLane, Math.round(currentTime + SIXTEENTH)]);
                        result.push([(burstLane + 2) % 4, Math.round(currentTime + SIXTEENTH * 2)]);
                    }

                    time += EIGHTH;
                }

                if (measure % 4 === 1) {
                    const runStart = time - EIGHTH;
                    for (let i = 0; i < 6; i++) {
                        const lane = (measure + i) % 4;
                        result.push([lane, Math.round(runStart + i * SIXTEENTH)]);
                    }
                }

                if (measure % 4 === 3) {
                    const jackBase = time;
                    for (let i = 0; i < 12; i++) {
                        const lane = i % 2 === 0 ? 0 : 3;
                        result.push([lane, Math.round(jackBase + i * (SIXTEENTH / 1.2))]);
                    }
                    time += SIXTEENTH * 4;
                }
            }

            result.sort((a, b) => a[1] - b[1]);
            return result;
        }

        const beatmap = generateBeatmap();
        const chartDuration = beatmap.reduce((max, [, timing]) => Math.max(max, timing), 0) + ARROW_TRAVEL_TIME + 1200;

        const keyMap = {
            'a': 0, 'A': 0, 'ArrowLeft': 0,
            's': 1, 'S': 1, 'ArrowDown': 1,
            'w': 2, 'W': 2, 'ArrowUp': 2,
            'd': 3, 'D': 3, 'ArrowRight': 3
        };

        const arrowSymbols = ['<', 'v', '^', '>'];

        function startGame() {
            clearScheduledTimeouts();
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('endScreen').classList.add('hidden');

            gameActive = true;
            gameStartTime = Date.now();
            score = 0;
            combo = 0;
            maxCombo = 0;
            perfect = 0;
            good = 0;
            miss = 0;
            arrows.forEach(arrow => arrow.remove());
            arrows = [];
            updateUI();
            document.getElementById('progressBar').style.width = '0%';

            spawnArrows();
            gameLoop();

            audio.currentTime = 0;
            audio.play().catch(() => {
                /* ignored: user gesture required */
            });
        }

        function spawnArrows() {
            beatmap.forEach(([lane, timing]) => {
                scheduleTimeout(() => {
                    if (gameActive) createArrow(lane);
                }, timing);
            });

            scheduleTimeout(() => {
                if (gameActive) {
                    endGame();
                }
            }, chartDuration);
        }

        function createArrow(lane) {
            const arrow = document.createElement('div');
            arrow.className = `arrow arrow-${lane}`;
            arrow.textContent = arrowSymbols[lane];
            arrow.dataset.lane = lane;
            arrow.dataset.spawnTime = Date.now();

            document.getElementById('gameContainer').appendChild(arrow);
            arrows.push(arrow);

            arrow.style.animationDuration = (ARROW_TRAVEL_TIME / 1000) + 's';

            scheduleTimeout(() => {
                if (arrow.parentElement) {
                    arrow.remove();
                    arrows = arrows.filter(a => a !== arrow);
                    if (gameActive && !arrow.dataset.hit) {
                        registerMiss();
                    }
                }
            }, ARROW_TRAVEL_TIME);
        }

        function gameLoop() {
            if (!gameActive) {
                return;
            }

            const elapsed = audio.currentTime > 0
                ? audio.currentTime * 1000
                : Date.now() - gameStartTime;
            const total = Math.max(songDurationMs, chartDuration);
            const progress = Math.min(100, (elapsed / total) * 100);
            document.getElementById('progressBar').style.width = progress + '%';

            requestAnimationFrame(gameLoop);
        }

        document.addEventListener('keydown', (event) => {
            if (!gameActive) {
                return;
            }

            const lane = keyMap[event.key];
            if (lane === undefined) {
                return;
            }

            const target = document.querySelector(`.target-${lane}`);
            target.style.transform = 'scale(1.15)';
            target.style.background = 'rgba(255, 255, 255, 0.25)';
            setTimeout(() => {
                target.style.transform = 'scale(1)';
                target.style.background = 'rgba(0, 0, 0, 0.55)';
            }, 100);

            checkHit(lane);
        });

        function checkHit(lane) {
            const targetArrows = arrows.filter(arrow =>
                parseInt(arrow.dataset.lane, 10) === lane && !arrow.dataset.hit
            );

            if (targetArrows.length === 0) {
                return;
            }

            let closestArrow = null;
            let minDistance = Infinity;
            const targetY = window.innerHeight - 70;

            targetArrows.forEach(arrow => {
                const rect = arrow.getBoundingClientRect();
                const distance = Math.abs(rect.top - targetY);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestArrow = arrow;
                }
            });

            if (!closestArrow || minDistance >= 150) {
                return;
            }

            closestArrow.dataset.hit = 'true';

            let judgment = 'miss';
            let points = 0;

            if (minDistance < 50) {
                judgment = 'perfect';
                points = 100;
                perfect += 1;
                combo += 1;
            } else if (minDistance < 100) {
                judgment = 'good';
                points = 50;
                good += 1;
                combo += 1;
            } else {
                miss += 1;
                combo = 0;
            }

            if (judgment !== 'miss') {
                score += points * (1 + combo * 0.1);
                if (combo > maxCombo) {
                    maxCombo = combo;
                }
            } else {
                score += points;
            }

            showJudgment(judgment);
            closestArrow.remove();
            arrows = arrows.filter(arrow => arrow !== closestArrow);
            updateUI();
        }

        function registerMiss() {
            miss += 1;
            combo = 0;
            showJudgment('miss');
            updateUI();
        }

        function showJudgment(type) {
            const judgment = document.createElement('div');
            judgment.className = `judgment ${type}`;
            judgment.textContent = type.toUpperCase();
            document.body.appendChild(judgment);

            setTimeout(() => judgment.remove(), 500);
        }

        function updateUI() {
            document.getElementById('score').textContent = `Score: ${Math.floor(score)}`;
            document.getElementById('combo').textContent = `Combo: ${combo}`;
            document.getElementById('accuracy').textContent =
                `Perfect: ${perfect} | Good: ${good} | Miss: ${miss}`;
        }

        function endGame() {
            if (!gameActive) {
                return;
            }

            gameActive = false;
            clearScheduledTimeouts();
            audio.pause();

            const totalNotes = perfect + good + miss;
            const accuracy = totalNotes > 0
                ? ((perfect + good) / totalNotes * 100).toFixed(2)
                : '0.00';

            let rank = 'F';
            if (accuracy >= 95) rank = 'S';
            else if (accuracy >= 90) rank = 'A';
            else if (accuracy >= 80) rank = 'B';
            else if (accuracy >= 70) rank = 'C';
            else if (accuracy >= 60) rank = 'D';

            document.getElementById('finalScore').textContent = `Final Score: ${Math.floor(score)}`;
            document.getElementById('finalStats').innerHTML =
                `Accuracy: ${accuracy}%<br>` +
                `Max Combo: ${maxCombo}<br>` +
                `Perfect: ${perfect} | Good: ${good} | Miss: ${miss}`;
            document.getElementById('rank').textContent = `Rank: ${rank}`;

            document.getElementById('endScreen').classList.remove('hidden');
        }

        function restartGame() {
            audio.pause();
            startGame();
        }

        function goBack() {
            audio.pause();
            audio.currentTime = 0;
            clearScheduledTimeouts();
            arrows.forEach(arrow => arrow.remove());
            arrows = [];
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
